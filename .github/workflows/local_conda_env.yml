name: Build MQC using local conda env (MPI, OpenMP, BLAS)

on: [push]

jobs:
  cmake-build:
    name: CMake build (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "with tblite"
            tblite: true
            legacy_mpi: false
          - name: "no tblite"
            tblite: false
            legacy_mpi: false
          - name: "with tblite + legacy MPI"
            tblite: true
            legacy_mpi: true
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          miniforge-version: latest

      - name: Install conda environment
        shell: bash -el {0}
        run: |
          conda env create --name mqc --file environment.yml
          conda install -c conda-forge -n mqc gfortran=14.2.0

      - name: Execute cmake and build
        shell: bash -el {0}
        run: |
          conda activate mqc
          export FC=gfortran
          cmake -DMQC_ENABLE_TBLITE=${{ matrix.tblite && 'ON' || 'OFF' }} \
                -DPIC_USE_LEGACY_MPI=${{ matrix.legacy_mpi && 'ON' || 'OFF' }} \
                -B build
          cmake --build build

      - name: Run unit tests
        shell: bash -el {0}
        run: |
          conda activate mqc
          ctest --test-dir build -V -R "mqc"

      - name: Run physics validation tests
        if: matrix.tblite
        shell: bash -el {0}
        run: |
          conda activate mqc
          cd validation
          python3 run_validation.py -v

      - name: Upload validation outputs on failure
        if: failure() && matrix.tblite
        uses: actions/upload-artifact@v4
        with:
          name: validation-outputs-tblite
          path: |
            validation/output_*.json
            validation/validation_logs/*.log
          retention-days: 7

  fpm-build:
    name: FPM build and test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          miniforge-version: latest

      - name: Install conda environment
        shell: bash -el {0}
        run: |
          conda env create --name mqc --file environment.yml
          conda install -c conda-forge -n mqc gfortran=14.2.0

      - name: Create blas and lapack symlinks for openblas
        shell: bash -el {0}
        run: |
          conda activate mqc
          ln -sf $CONDA_PREFIX/lib/libopenblas.so $CONDA_PREFIX/lib/libblas.so
          ln -sf $CONDA_PREFIX/lib/libopenblas.so $CONDA_PREFIX/lib/liblapack.so

      - name: Build with fpm
        shell: bash -el {0}
        run: |
          conda activate mqc
          fpm build --compiler mpifort

      - name: Run fpm tests
        shell: bash -el {0}
        run: |
          conda activate mqc
          fpm test --compiler mpifort
